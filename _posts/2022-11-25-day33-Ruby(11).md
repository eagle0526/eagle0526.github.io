---
title: ASTRO Camp Day33 - Ruby(11)
author: YeeChen
date: 2022-11-25
category: Ruby
layout: post
---




最後再來處理checkout的畫面了，新增一個checkout.erb.html





paypal金流練習
------

[串金流](https://developer.paypal.com/braintree/docs/start/overview)

先到上面網址註冊一個帳號，記得要註冊sandbox的，他是給你測試用的
註冊好後去信箱收信，從連結登入就可以

Merchant ID: qd67cfzt9hnn9x63
Public Key: 8d6yq4mgg9tps32t
Private Key: 8fd0051c25d881d0b890466c264339cb


SDK是什麼 - 軟體開發套件

等等要用的是客戶端和server端的SDK


Client SDKs for Android, iOS, and JavaScript
Server SDKs for Java, .NET, Node.js, PHP, Python, and Ruby




10:40
刷卡流程介紹

nonce = 用一次的隨機數字


> --  
> 在台灣如果你要在你的server存取信用卡卡號，要符合pci compliance的規定  
> --  
{: .block-warning}




在checkout建立
```md
<h2>結帳</h2>
<%= params %>
<div id="dropin" data-controller="paypal-dropin"></div>

```




新的controller來做paypal_dropin_controller
```md

import { Controller } from "stimulus"



export default class extends Controller {
  static targets = [  ]

  initialize() {  }
  connect() {
    console.log("123");
  }
}

```



我們來使用npm的方法來抓金流
先不要用cdn的方法
https://www.npmjs.com/package/braintree-web-drop-in

braintree的npm
```md
yarn add braintree-web-drop-in
```


輸入完指令後，先出找到module檔案裡，braintree的名字，接著import先隨便試，因為不知道對方怎麼export的
所以那邊名字隨便打都可以，如果這樣不行的話，再加上大括號試試

```md
import { Controller } from "stimulus"
import braintree from "braintree-web-drop-in"


export default class extends Controller {
  static targets = [  ]

  initialize() {  }
  connect() {
    console.log("123");
    console.log(braintree);
  }

}
```




接著把dropin的流程用fetch寫好



11:27 server端的流程


載入braintree提供的gem
```md
> gem "braintree", "~> 4.9.0"
```

重新bundle
```md
> bundle
```

接下來幫商店的金鑰，在controller貼上







測試卡好
visa給的測試卡號 第一個是4
後面全都是1
4111111111111111
日期隨便填



接下來要做一個form給刷卡機
我們要做一個路徑接收剛剛傳過來的東西




下午的課


龍哥試一次抓github的專案，

clone下來
bundle
yarn install

把.env.example改成.env

最後再把三個商店的key回填到.env上，就可以完成了






改變訂單狀態

有限狀態機
------

狀態機的概念是說，打開狀態只能關閉 關閉狀態只打開

為什麼要引入狀態機

狀態機的意思就是會引入很多狀態，每個狀態間都會有一個動詞
狀態機就是一堆的if/else



state machine gem
aasm 




pending  ------- >  cancelled               ---->
                                    paid                
         ------- >  cancelled               ---->




fsm有一個重點，就是“有限“狀態機，不是無限的
無限是啥意思呢！？

我們是經由操作他的動作，去改變它的狀態
而不是直接改變它的狀態

ex. 我是用關門這個動作，來讓打開的門關閉，而不是啥都不做原本打開的門，門就關起來了




有限狀態機不只可以用在model身上，其他情況也是可以用的，只是這裡剛好很適合用到在model上







linter
------
可以整理你JS的檔案



rubocop
------
可以整理你ruby的檔案


rubocop-rails
------
專門整理rails檔案的插件


把rails不符合style的
```md
> rubocop
```

可以直接休一大堆檔案
```md
rubocop -A 
```


在做專案的時候，先把規矩都訂好，把






跑測試
------

bundle init可以建出一個空的gemfile


mini-test - ruby內建，比較快
rspec - 另外安裝，比較慢一點



bundle add rspec

測試就是在跑規格，先把規格訂好


建立新的檔案，並開始跑
```md
bank_spec.rb

```


先開好規格

存錢功能
1. 可以存錢
2. 不可以存0元或是小於0元的金額(越存錢越少)

領錢功能

1. 可以領錢
2. 不能領0元或是小於0元的金額
3. 不能領超過本身的餘額














































